---
- hosts: SERVERBDD
  become: yes
  tasks:
  - name: Use /usr/bin/python3 as default interpreter
    set_fact:
      ansible_python_interpreter: /usr/bin/python3

  - name: Install MariaDB
    yum:
      name: mariadb-server
      state: latest
      update_cache: yes

  - name: Enable MariaDB service
    service:
      name: mariadb
      state: started
      enabled: yes

  - name: Install python3 and PyMySQL
    yum:
      name:
        - python3
        - python3-pip
      state: present

  - name: Create Database
    mysql_db:
      name: SNOW
      login_user: root
      login_password: T001k1t_2022
      state: present

  - name: Create mysql User defined database
    mysql_user:
      name: snowuser
      password: snowuser
      priv: 'SNOW.*:ALL,GRANT'
      login_user: root
      login_password: T001k1t_2022
      state: present

  - name: Ensure MariaDB listens on the correct port
    lineinfile:
      path: /etc/my.cnf.d/server.cnf
      insertafter: '\[mysqld\]'
      line: 'port = 3306'
      state: present

  - name: Restart MariaDB service
    service:
      name: mariadb
      state: restarted
  
  - name: Install firewalld
    yum:
      name: firewalld
      state: present
  - name: Start firewalld
    service:
      name: firewalld
      state: started
  - name: Open port 4000/tcp
    firewalld:
       port: 4000/tcp
       permanent: yes
       state: enabled
       immediate: yes
